# ğŸ“š YA_MCPServer_KnowledgeAgent æ“ä½œæ‰‹å†Œ

## ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
- [2. æ¶æ„ä¸å®ç°é€»è¾‘](#2-æ¶æ„ä¸å®ç°é€»è¾‘)
- [3. æ•°æ®å­˜å‚¨æ ¼å¼](#3-æ•°æ®å­˜å‚¨æ ¼å¼)
- [4. å¯åŠ¨ä¸æµ‹è¯•](#4-å¯åŠ¨ä¸æµ‹è¯•)
- [5. æ‰€æœ‰ MCP å·¥å…·è¯¦è§£](#5-æ‰€æœ‰-mcp-å·¥å…·è¯¦è§£)
- [6. è„±ç¦» MCP Server ç›´æ¥ä½¿ç”¨](#6-è„±ç¦»-mcp-server-ç›´æ¥ä½¿ç”¨)
- [7. æ‰©å±•åŠŸèƒ½æŒ‡å—](#7-æ‰©å±•åŠŸèƒ½æŒ‡å—)
- [8. å¸¸è§é—®é¢˜](#8-å¸¸è§é—®é¢˜)

---

## 1. é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª **åŸºäº RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰çš„ä¸ªæ€§åŒ–çŸ¥è¯†ç®¡ç†æ™ºèƒ½ä½“**ï¼Œæ ¸å¿ƒèƒ½åŠ›ï¼š

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| çŸ¥è¯†å­˜å‚¨ | å°†æ–‡æœ¬è‡ªåŠ¨åˆ†å—ã€å‘é‡åŒ–åå­˜å…¥ ChromaDB |
| è¯­ä¹‰æœç´¢ | è¾“å…¥è‡ªç„¶è¯­è¨€ï¼ŒæŒ‰è¯­ä¹‰ï¼ˆè€Œéå…³é”®è¯ï¼‰åŒ¹é…çŸ¥è¯† |
| RAG é—®ç­” | æ£€ç´¢ç›¸å…³çŸ¥è¯† â†’ æ‹¼æ¥ä¸ºä¸Šä¸‹æ–‡ â†’ DeepSeek ç”Ÿæˆå›ç­” |
| æ™ºèƒ½å¯¹è¯ | ç›´æ¥è°ƒç”¨ DeepSeek è¿›è¡Œé€šç”¨å¯¹è¯ |
| ç¿»è¯‘ | MyMemory å…è´¹ API å¤šè¯­è¨€äº’è¯‘ |

API Key é€šè¿‡ SOPS åŠ å¯†ç®¡ç†ï¼ˆ`env.yaml`ï¼‰ï¼Œä¸å†™å…¥ç¯å¢ƒå˜é‡æˆ–ä»£ç ã€‚

---

## 2. æ¶æ„ä¸å®ç°é€»è¾‘

### 2.1 æ•´ä½“æ¶æ„

```
ç”¨æˆ·/MCPå®¢æˆ·ç«¯
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MCP Serverï¼ˆserver.py, SSE @ 127.0.0.1:12345ï¼‰  â”‚
â”‚                                                  â”‚
â”‚  tools/             â† MCP å·¥å…·å±‚ï¼ˆæ¥å£å®šä¹‰ï¼‰       â”‚
â”‚    â”œâ”€ chat_tool.py      â†’ smart_chat             â”‚
â”‚    â”œâ”€ knowledge_tool.py â†’ add/search/list/delete â”‚
â”‚    â”œâ”€ qa_tool.py        â†’ ask_knowledge, stats   â”‚
â”‚    â”œâ”€ translate_tool.py â†’ text_translate          â”‚
â”‚    â””â”€ weather_tool.py   â†’ weather_query          â”‚
â”‚                                                  â”‚
â”‚  core/              â† æ ¸å¿ƒä¸šåŠ¡å±‚ï¼ˆé€»è¾‘å®ç°ï¼‰       â”‚
â”‚    â”œâ”€ llm_service.py        â†’ DeepSeek API è°ƒç”¨  â”‚
â”‚    â”œâ”€ knowledge_store.py    â†’ ChromaDB æ“ä½œ      â”‚
â”‚    â”œâ”€ rag_service.py        â†’ RAG æµç¨‹ç¼–æ’        â”‚
â”‚    â”œâ”€ document_processor.py â†’ æ–‡æœ¬åˆ†å—            â”‚
â”‚    â”œâ”€ translate_service.py  â†’ ç¿»è¯‘ API           â”‚
â”‚    â””â”€ weather_service.py    â†’ å¤©æ°” API           â”‚
â”‚                                                  â”‚
â”‚  modules/           â† å…¬å…±æ¨¡å—                    â”‚
â”‚    â”œâ”€ YA_Common/    â†’ é…ç½®ã€æ—¥å¿—ã€ä¸­é—´ä»¶           â”‚
â”‚    â””â”€ YA_Secrets/   â†’ SOPS è§£å¯†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChromaDB     â”‚  â”‚ DeepSeek API â”‚  â”‚ env.yaml     â”‚
â”‚ ./data/      â”‚  â”‚ï¼ˆå¤–éƒ¨æœåŠ¡ï¼‰    â”‚  â”‚ï¼ˆSOPSåŠ å¯†ï¼‰   â”‚
â”‚ chromadb/    â”‚  â”‚              â”‚  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒè°ƒç”¨é“¾

#### æ·»åŠ çŸ¥è¯† `add_knowledge`

```
ç”¨æˆ·è¾“å…¥ content/title/tags/source
    â”‚
    â–¼
tools/knowledge_tool.py::add_knowledge()      â† MCP å…¥å£
    â”‚
    â–¼
core/knowledge_store.py::add_knowledge()       â† ä¸šåŠ¡é€»è¾‘
    â”‚
    â”œâ”€â†’ core/document_processor.py::split_text()   â† æ–‡æœ¬åˆ†å—
    â”‚       æŠŠé•¿æ–‡æœ¬æŒ‰ 500 å­—åˆ‡åˆ†ï¼Œå¥å·/æ¢è¡Œå¤„ä¼˜å…ˆæ–­å¼€
    â”‚       ç›¸é‚»ç‰‡æ®µæœ‰ 50 å­—é‡å é¿å…ä¿¡æ¯ä¸¢å¤±
    â”‚
    â–¼
    ChromaDB collection.add(ids, documents, metadatas)
        ChromaDB å†…éƒ¨è‡ªåŠ¨è°ƒç”¨ all-MiniLM-L6-v2 æ¨¡å‹
        æŠŠæ¯ä¸ªæ–‡æœ¬ç‰‡æ®µè½¬ä¸º 384 ç»´å‘é‡å¹¶å­˜å‚¨
```

#### è¯­ä¹‰æœç´¢ `search_knowledge`

```
ç”¨æˆ·è¾“å…¥ queryï¼ˆè‡ªç„¶è¯­è¨€ï¼‰
    â”‚
    â–¼
tools/knowledge_tool.py::search_knowledge()
    â”‚
    â–¼
core/knowledge_store.py::search_knowledge()
    â”‚
    â–¼
    ChromaDB collection.query(query_texts=[query], n_results=5)
        ChromaDB è‡ªåŠ¨å°† query å‘é‡åŒ–
        è®¡ç®—ä¸æ‰€æœ‰å­˜å‚¨å‘é‡çš„ä½™å¼¦è·ç¦»
        è¿”å›æœ€è¿‘çš„ top_k ä¸ªç»“æœ + è·ç¦»å€¼
    â”‚
    â–¼
    æ ¼å¼åŒ–: relevance = 1 - distanceï¼ˆè·ç¦»è¶Šå°è¶Šç›¸å…³ï¼‰
    è¿”å› [{id, content, title, tags, relevance}, ...]
```

#### RAG é—®ç­” `ask_knowledge`ï¼ˆæœ€æ ¸å¿ƒï¼‰

```
ç”¨æˆ·æé—® question
    â”‚
    â–¼
tools/qa_tool.py::ask_knowledge()
    â”‚
    â–¼
core/rag_service.py::ask_knowledge()
    â”‚
    â”œâ”€â‘  æ£€ç´¢: core/knowledge_store.py::search_knowledge(question)
    â”‚       è¯­ä¹‰æœç´¢ï¼Œæ‰¾åˆ°æœ€ç›¸å…³çš„ 5 ä¸ªçŸ¥è¯†ç‰‡æ®µ
    â”‚
    â”œâ”€â‘¡ è¿‡æ»¤: ä¸¢å¼ƒ relevance < 0.3 çš„ä½ç›¸å…³ç»“æœ
    â”‚
    â”œâ”€â‘¢ æ‹¼æ¥ä¸Šä¸‹æ–‡:
    â”‚       æŠŠæ¯ä¸ªç‰‡æ®µæ ¼å¼åŒ–ä¸º:
    â”‚       "ã€çŸ¥è¯†1ã€‘(æ¥æº: Pythonæ•™ç¨‹, ç›¸å…³åº¦: 0.85)\nçŸ¥è¯†å†…å®¹..."
    â”‚       ç”¨ "---" åˆ†éš”ååµŒå…¥ RAG_SYSTEM_PROMPT æ¨¡æ¿
    â”‚
    â”œâ”€â‘£ è°ƒç”¨ DeepSeek:
    â”‚       core/llm_service.py::chat_with_llm(
    â”‚           message=question,
    â”‚           system_prompt=RAG_SYSTEM_PROMPT.format(context=æ‹¼æ¥å†…å®¹)
    â”‚       )
    â”‚       â†’ _get_api_key() ä» SOPS è§£å¯† env.yaml è·å– deepseek_api_key
    â”‚       â†’ AsyncOpenAI(base_url="https://api.deepseek.com") å‘é€è¯·æ±‚
    â”‚
    â””â”€â‘¤ è¿”å›:
          {question, answer, sources, context_chunks_used, token_usage}
```

#### API Key è·å–é“¾

```
_get_api_key()
    â”‚
    â”œâ”€ ä¼˜å…ˆ: modules/YA_Secrets/secrets_parser.py::get_secret("deepseek_api_key")
    â”‚          â””â”€ subprocess è°ƒç”¨ sops -d env.yaml
    â”‚          â””â”€ è§£æ YAML â†’ secrets.deepseek_api_key
    â”‚
    â””â”€ å¤‡ç”¨: os.environ.get("DEEPSEEK_API_KEY")
```

---

## 3. æ•°æ®å­˜å‚¨æ ¼å¼

### 3.1 ChromaDB å‘é‡æ•°æ®åº“

**ç‰©ç†ä½ç½®ï¼š** `./data/chromadb/`ï¼ˆæœ¬åœ°æ–‡ä»¶å¤¹ï¼Œè‡ªåŠ¨åˆ›å»ºï¼‰

**é›†åˆåï¼š** `knowledge_base`ï¼ˆå¯åœ¨ config.yaml ä¿®æ”¹ï¼‰

**æ¯æ¡çŸ¥è¯†åœ¨æ•°æ®åº“ä¸­çš„ç»“æ„ï¼š**

```
ä¸€ç¯‡çŸ¥è¯†è¢«åˆ†ä¸º N ä¸ª chunkï¼Œæ¯ä¸ª chunk ç‹¬ç«‹å­˜å‚¨ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ chunk 0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id:       "kb_a1b2c3d4_chunk0" â”‚  â† å”¯ä¸€æ ‡è¯†
â”‚ document: "çŸ¥è¯†æ–‡æœ¬å†…å®¹..."      â”‚  â† åŸå§‹æ–‡æœ¬ï¼ˆæ˜æ–‡ï¼‰
â”‚ embedding: [0.12, -0.34, ...]  â”‚  â† 384ç»´å‘é‡ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚ metadata:                      â”‚
â”‚   title:       "Pythonè£…é¥°å™¨"   â”‚
â”‚   tags:        "python,ç¼–ç¨‹"    â”‚
â”‚   source:      "è¯¾ä»¶"           â”‚
â”‚   base_id:     "kb_a1b2c3d4"  â”‚  â† åŒä¸€ç¯‡çŸ¥è¯†çš„æ‰€æœ‰chunkå…±äº«
â”‚   chunk_index: 0              â”‚
â”‚   total_chunks: 3             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹ï¼š**
- `document` æ˜¯æ˜æ–‡å­˜å‚¨ï¼Œä¸åŠ å¯†
- `embedding` ç”± ChromaDB å†…ç½®çš„ `all-MiniLM-L6-v2` æ¨¡å‹è‡ªåŠ¨ç”Ÿæˆï¼Œæ— éœ€è°ƒç”¨å¤–éƒ¨ API
- `base_id` ç”¨æ¥æŠŠåŒä¸€ç¯‡çŸ¥è¯†çš„æ‰€æœ‰ chunk å…³è”èµ·æ¥ï¼ˆåˆ é™¤æ—¶æŒ‰ base_id æ‰¹é‡åˆ é™¤ï¼‰
- æ•°æ®æŒä¹…åŒ–åœ¨ç£ç›˜ï¼Œé‡å¯æœåŠ¡å™¨ä¸ä¸¢å¤±

### 3.2 åˆ†å—è§„åˆ™ï¼ˆdocument_processor.pyï¼‰

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| chunk_size | 500 å­—ç¬¦ | æ¯ä¸ªç‰‡æ®µæœ€å¤§é•¿åº¦ |
| chunk_overlap | 50 å­—ç¬¦ | ç›¸é‚»ç‰‡æ®µé‡å åŒºï¼Œé¿å…è¾¹ç•Œä¿¡æ¯ä¸¢å¤± |

ä¼˜å…ˆåœ¨è‡ªç„¶æ–­ç‚¹åˆ‡åˆ†ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š`\n\n` â†’ `\n` â†’ `ã€‚` â†’ `ï¼` â†’ `ï¼Ÿ` â†’ `. ` â†’ `! ` â†’ `? ` â†’ `ï¼›`

å¦‚æœæ–‡æœ¬ â‰¤ 500 å­—ï¼Œä¸åˆ†å—ï¼Œæ•´æ®µä½œä¸ºä¸€ä¸ª chunkã€‚

### 3.3 env.yamlï¼ˆSOPS åŠ å¯†ï¼‰

```yaml
# è§£å¯†åçš„ç»“æ„ï¼š
secrets:
  deepseek_api_key: "sk-xxxxxxxxxxxx"
```

åŠ å¯†åçš„ env.yaml å¯ä»¥å®‰å…¨æäº¤åˆ° Gitï¼Œåªæœ‰æŒæœ‰ age ç§é’¥çš„äººèƒ½è§£å¯†ã€‚

---

## 4. å¯åŠ¨ä¸æµ‹è¯•

### 4.1 å¯åŠ¨æœåŠ¡å™¨

```powershell
cd "d:\Syncthing Folder\Asus-Lenovo\School Projects\project_agent\YA_MCPServer_Template"
uv run server.py
```

æœåŠ¡è¿è¡Œåœ¨ `http://127.0.0.1:12345`ï¼Œä¼ è¾“åè®®ï¼šSSEã€‚

### 4.2 ç”¨ MCP Inspector æµ‹è¯•

```powershell
# æ–°ç»ˆç«¯çª—å£
npx @anthropic/mcp-inspector
```

æµè§ˆå™¨æ‰“å¼€ Inspector â†’ è¿æ¥ `http://127.0.0.1:12345/sse`

**æµ‹è¯•æµç¨‹ï¼š**

```
æ­¥éª¤ 1ï¸âƒ£  æ·»åŠ çŸ¥è¯†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: add_knowledge
å‚æ•°:
  content: "Python è£…é¥°å™¨æ˜¯ä¸€ç§å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ªæ–°å‡½æ•°ã€‚
            å¸¸è§å†…ç½®è£…é¥°å™¨æœ‰ @propertyã€@staticmethodã€@classmethodã€‚
            è‡ªå®šä¹‰è£…é¥°å™¨ç¤ºä¾‹ï¼š
            def timer(func):
                import time
                def wrapper(*args, **kwargs):
                    start = time.time()
                    result = func(*args, **kwargs)
                    print(f'è€—æ—¶: {time.time()-start:.2f}ç§’')
                    return result
                return wrapper"
  title: "Pythonè£…é¥°å™¨æ•™ç¨‹"
  tags: "python,ç¼–ç¨‹,è£…é¥°å™¨"
  source: "è¯¾ä»¶"

é¢„æœŸè¿”å›:
  {"id": "kb_xxxxxxxx", "title": "Pythonè£…é¥°å™¨æ•™ç¨‹", "chunks_count": 1, "message": "çŸ¥è¯†æ·»åŠ æˆåŠŸ"}

æ­¥éª¤ 2ï¸âƒ£  è¯­ä¹‰æœç´¢ï¼ˆæ³¨æ„ï¼šä¸éœ€è¦ç²¾ç¡®åŒ¹é…å…³é”®è¯ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: search_knowledge
å‚æ•°:
  query: "å¦‚ä½•ç»™å‡½æ•°è®¡æ—¶"     â† æ²¡æ"è£…é¥°å™¨"ä½†è¯­ä¹‰ç›¸å…³

é¢„æœŸ: è¿”å›è£…é¥°å™¨ç›¸å…³çš„çŸ¥è¯†ç‰‡æ®µï¼Œrelevance > 0.5

æ­¥éª¤ 3ï¸âƒ£  RAG é—®ç­”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: ask_knowledge
å‚æ•°:
  question: "Pythonä¸­æ€ä¹ˆåœ¨å‡½æ•°å‰åè‡ªåŠ¨æ‰“å°æ—¥å¿—ï¼Ÿ"

é¢„æœŸ: DeepSeek åŸºäºçŸ¥è¯†åº“ä¸­çš„è£…é¥°å™¨çŸ¥è¯†ç”Ÿæˆå›ç­”ï¼Œé™„å¸¦æ¥æºå¼•ç”¨

æ­¥éª¤ 4ï¸âƒ£  æŸ¥çœ‹ç»Ÿè®¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: knowledge_stats
ï¼ˆæ— å‚æ•°ï¼‰

é¢„æœŸ: {"total_items": 1, "total_chunks": 1, "tags": {"python": 1, ...}}

æ­¥éª¤ 5ï¸âƒ£  åˆ—å‡ºçŸ¥è¯†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: list_knowledge
ï¼ˆæ— å‚æ•°æˆ– tag_filter: "python"ï¼‰

æ­¥éª¤ 6ï¸âƒ£  åˆ é™¤çŸ¥è¯†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: delete_knowledge
å‚æ•°:
  knowledge_id: "kb_xxxxxxxx"   â† æ­¥éª¤1è¿”å›çš„ id

æ­¥éª¤ 7ï¸âƒ£  ç›´æ¥å¯¹è¯ï¼ˆä¸ç»è¿‡çŸ¥è¯†åº“ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Tool: smart_chat
å‚æ•°:
  message: "ä»€ä¹ˆæ˜¯é‡å­è®¡ç®—ï¼Ÿ"
```

### 4.3 ç”¨ MCP dev æ¨¡å¼æµ‹è¯•

```powershell
uv run mcp dev server.py
```

---

## 5. æ‰€æœ‰ MCP å·¥å…·è¯¦è§£

### 5.1 çŸ¥è¯†ç®¡ç†ç±»

| å·¥å…·å | å…¥å£æ–‡ä»¶ | æ ¸å¿ƒå‡½æ•° | å‚æ•° | è¿”å›å€¼ |
|--------|----------|----------|------|--------|
| `add_knowledge` | tools/knowledge_tool.py | core/knowledge_store.py::add_knowledge() | content(å¿…å¡«), title, tags, source | {id, title, tags, chunks_count, message} |
| `search_knowledge` | tools/knowledge_tool.py | core/knowledge_store.py::search_knowledge() | query(å¿…å¡«), top_k=5, tag_filter | {query, total_results, results: [{id, content, title, relevance}]} |
| `list_knowledge` | tools/knowledge_tool.py | core/knowledge_store.py::list_knowledge() | tag_filter, limit=20 | {total_items, total_chunks, items: [{id, title, preview}]} |
| `delete_knowledge` | tools/knowledge_tool.py | core/knowledge_store.py::delete_knowledge() | knowledge_id(å¿…å¡«) | {message} |

### 5.2 RAG é—®ç­”ç±»

| å·¥å…·å | å…¥å£æ–‡ä»¶ | æ ¸å¿ƒå‡½æ•° | å‚æ•° | è¿”å›å€¼ |
|--------|----------|----------|------|--------|
| `ask_knowledge` | tools/qa_tool.py | core/rag_service.py::ask_knowledge() | question(å¿…å¡«), top_k=5 | {question, answer, sources, context_chunks_used, token_usage} |
| `knowledge_stats` | tools/qa_tool.py | core/knowledge_store.py::get_stats() | æ—  | {total_items, total_chunks, tags, sources} |

### 5.3 é€šç”¨ç±»

| å·¥å…·å | å…¥å£æ–‡ä»¶ | æ ¸å¿ƒå‡½æ•° | å‚æ•° | è¿”å›å€¼ |
|--------|----------|----------|------|--------|
| `smart_chat` | tools/chat_tool.py | core/llm_service.py::chat_with_llm() | message(å¿…å¡«), system_prompt | {provider, model, reply, usage} |
| `text_translate` | tools/translate_tool.py | core/translate_service.py::translate_text() | text(å¿…å¡«), target_lang="è‹±æ–‡", source_lang="auto" | {original, translated, source_lang, target_lang} |
| `get_supported_languages` | tools/translate_tool.py | core/translate_service.py::get_supported_languages() | æ—  | {"ä¸­æ–‡": "zh-CN", ...} |
| `weather_query` | tools/weather_tool.py | core/weather_service.py::query_weather() | city(å¿…å¡«) | {city, temperature, weather, humidity, wind} |

---

## 6. è„±ç¦» MCP Server ç›´æ¥ä½¿ç”¨

ChromaDB æ•°æ®åº“å¯ä»¥å®Œå…¨è„±ç¦» MCP Server ç‹¬ç«‹è®¿é—®ã€‚

### 6.1 Python è„šæœ¬ç›´æ¥è¯»å–çŸ¥è¯†åº“

```python
# standalone_query.py - ä¸å¯åŠ¨ MCP Serverï¼Œç›´æ¥æŸ¥çœ‹çŸ¥è¯†åº“
import chromadb

# è¿æ¥åˆ°åŒä¸€ä¸ªæ•°æ®åº“
client = chromadb.PersistentClient(path="./data/chromadb")
collection = client.get_collection("knowledge_base")

# æŸ¥çœ‹æ€»æ•°
print(f"çŸ¥è¯†åº“å…± {collection.count()} ä¸ªæ–‡æœ¬ç‰‡æ®µ")

# åˆ—å‡ºæ‰€æœ‰çŸ¥è¯†
all_data = collection.get()
for i in range(len(all_data["ids"])):
    print(f"\n--- {all_data['ids'][i]} ---")
    print(f"  æ ‡é¢˜: {all_data['metadatas'][i].get('title', '')}")
    print(f"  æ ‡ç­¾: {all_data['metadatas'][i].get('tags', '')}")
    print(f"  å†…å®¹: {all_data['documents'][i][:100]}...")

# è¯­ä¹‰æœç´¢
results = collection.query(query_texts=["è£…é¥°å™¨æ€ä¹ˆç”¨"], n_results=3)
for i in range(len(results["ids"][0])):
    print(f"\nåŒ¹é…: {results['documents'][0][i][:80]}...")
    print(f"  è·ç¦»: {results['distances'][0][i]:.4f}")
```

è¿è¡Œæ–¹å¼ï¼š
```powershell
.\.venv\Scripts\python.exe standalone_query.py
```

### 6.2 å¯¼å‡ºçŸ¥è¯†ä¸º JSON

```python
import chromadb
import json

client = chromadb.PersistentClient(path="./data/chromadb")
collection = client.get_collection("knowledge_base")
all_data = collection.get()

export = []
for i in range(len(all_data["ids"])):
    export.append({
        "id": all_data["ids"][i],
        "content": all_data["documents"][i],
        "metadata": all_data["metadatas"][i],
    })

with open("knowledge_export.json", "w", encoding="utf-8") as f:
    json.dump(export, f, ensure_ascii=False, indent=2)

print(f"å·²å¯¼å‡º {len(export)} æ¡åˆ° knowledge_export.json")
```

### 6.3 ç›´æ¥è°ƒç”¨ core æ¨¡å—ï¼ˆasyncioï¼‰

```python
import asyncio
import sys
sys.path.insert(0, ".")

async def main():
    # ç›´æ¥è°ƒç”¨ core å±‚ï¼Œæ— éœ€ MCP Server
    from core.knowledge_store import add_knowledge, search_knowledge, get_stats
    from core.rag_service import ask_knowledge

    # æ·»åŠ çŸ¥è¯†
    result = await add_knowledge(
        content="æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯...",
        title="æœºå™¨å­¦ä¹ å…¥é—¨",
        tags="AI,æœºå™¨å­¦ä¹ ",
        source="ç¬”è®°"
    )
    print(result)

    # æœç´¢
    results = await search_knowledge(query="ä»€ä¹ˆæ˜¯AI")
    print(results)

    # RAG é—®ç­”ï¼ˆéœ€è¦ SOPS èƒ½è§£å¯† + DeepSeek å¯ç”¨ï¼‰
    answer = await ask_knowledge(question="æœºå™¨å­¦ä¹ æœ‰å“ªäº›åº”ç”¨ï¼Ÿ")
    print(answer)

asyncio.run(main())
```

### 6.4 æ•°æ®åº“æ–‡ä»¶è¯´æ˜

```
./data/chromadb/
â”œâ”€â”€ chroma.sqlite3          â† ä¸»æ•°æ®åº“æ–‡ä»¶ï¼ˆidã€metadataã€æ–‡æœ¬ï¼‰
â”œâ”€â”€ xxxxxxxx-xxxx-xxxx-.../
â”‚   â”œâ”€â”€ data_level0.bin     â† å‘é‡ç´¢å¼•ï¼ˆHNSW æ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ header.bin          â† ç´¢å¼•å¤´ä¿¡æ¯
â”‚   â””â”€â”€ length.bin          â† å‘é‡é•¿åº¦
```

**å¤‡ä»½çŸ¥è¯†åº“**ï¼šç›´æ¥å¤åˆ¶æ•´ä¸ª `./data/chromadb/` æ–‡ä»¶å¤¹å³å¯ã€‚
**æ¢å¤çŸ¥è¯†åº“**ï¼šæŠŠå¤‡ä»½çš„æ–‡ä»¶å¤¹æ”¾å› `./data/chromadb/`ï¼Œé‡å¯æœåŠ¡å™¨ã€‚

---

## 7. æ‰©å±•åŠŸèƒ½æŒ‡å—

### 7.1 æ·»åŠ æ–°çš„ MCP å·¥å…·ï¼ˆä»¥ "çŸ¥è¯†å¯¼å…¥æ–‡ä»¶" ä¸ºä¾‹ï¼‰

**æ­¥éª¤ 1ï¼š** åœ¨ `core/` å†™ä¸šåŠ¡é€»è¾‘

```python
# core/file_importer.py
from core.knowledge_store import add_knowledge

async def import_from_file(file_path: str) -> dict:
    with open(file_path, "r", encoding="utf-8") as f:
        content = f.read()
    return await add_knowledge(content=content, title=file_path, source="æ–‡ä»¶å¯¼å…¥")
```

**æ­¥éª¤ 2ï¼š** åœ¨ `tools/` æ³¨å†Œ MCP å·¥å…·

```python
# tools/import_tool.py
from typing import Any, Dict
from tools import YA_MCPServer_Tool

@YA_MCPServer_Tool(
    name="import_file",
    title="Import File",
    description="ä»æ–‡ä»¶å¯¼å…¥çŸ¥è¯†åˆ°çŸ¥è¯†åº“",
)
async def import_file(file_path: str) -> Dict[str, Any]:
    from core.file_importer import import_from_file
    return await import_from_file(file_path=file_path)
```

**æ­¥éª¤ 3ï¼š** å®Œæˆï¼`tools/__init__.py` ä¼šè‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œï¼Œæ— éœ€æ‰‹åŠ¨æ³¨å†Œã€‚

### 7.2 æ·»åŠ æ–°çš„ AI æä¾›å•†

åœ¨ `core/llm_service.py` çš„ `chat_with_llm()` ä¸­æ‰©å±• provider åˆ†æ”¯ï¼š

```python
# åœ¨ chat_with_llm() ä¸­ï¼š
if provider == "deepseek":
    base_url = ...
    model = ...
elif provider == "new_provider":
    base_url = get_config("llm.new_provider.base_url")
    model = get_config("llm.new_provider.model")
```

åœ¨ `config.yaml` ä¸­æ·»åŠ ï¼š
```yaml
llm:
  new_provider:
    base_url: "https://api.xxx.com"
    model: "xxx-model"
```

åœ¨ `env.yaml` ä¸­ç”¨ SOPS åŠ å¯†æ–°çš„ API Keyã€‚

### 7.3 ä¿®æ”¹åˆ†å—å‚æ•°

ç¼–è¾‘ `config.yaml`ï¼š

```yaml
knowledge:
  chunking:
    chunk_size: 800      # å¢å¤§åˆ° 800 å­—ï¼ˆé€‚åˆé•¿æ–‡ç« ï¼‰
    chunk_overlap: 100   # å¢å¤§é‡å åŒº
```

æ³¨æ„ï¼šä¿®æ”¹å‚æ•°åï¼Œ**å·²æœ‰çŸ¥è¯†ä¸ä¼šé‡æ–°åˆ†å—**ï¼Œåªå½±å“æ–°æ·»åŠ çš„çŸ¥è¯†ã€‚

### 7.4 æ·»åŠ æ–°çš„ Resource

```python
# resources/my_resource.py
from resources import YA_MCPServer_Resource

@YA_MCPServer_Resource(
    "docs://my-resource",
    name="my_resource",
    title="My Resource",
    description="è‡ªå®šä¹‰èµ„æº",
    mime_type="text/markdown",
)
def get_my_resource() -> str:
    return "# èµ„æºå†…å®¹"
```

### 7.5 æ·»åŠ æ–°çš„ Prompt

```python
# prompts/my_prompt.py
from prompts import YA_MCPServer_Prompt

@YA_MCPServer_Prompt(
    name="my_prompt",
    title="My Prompt",
    description="è‡ªå®šä¹‰æç¤ºè¯",
)
async def my_prompt(topic: str) -> str:
    return f"è¯·å¸®æˆ‘åˆ†æã€Œ{topic}ã€çš„ä¼˜ç¼ºç‚¹ã€‚"
```

---

## 8. å¸¸è§é—®é¢˜

### Q: ChromaDB é¦–æ¬¡å¯åŠ¨å¾ˆæ…¢ï¼Ÿ
é¦–æ¬¡ä½¿ç”¨æ—¶ ChromaDB ä¼šä¸‹è½½ `all-MiniLM-L6-v2` åµŒå…¥æ¨¡å‹ï¼ˆçº¦ 80MBï¼‰ï¼Œä¹‹åç¼“å­˜åˆ°æœ¬åœ°ã€‚

### Q: SOPS è§£å¯†å¤±è´¥ï¼Ÿ
- ç¡®è®¤ `sops` å‘½ä»¤å¯ç”¨ï¼š`sops --version`
- ç¡®è®¤ age ç§é’¥ä½ç½®æ­£ç¡®ï¼š`$env:SOPS_AGE_KEY_FILE` æŒ‡å‘ `C:\Users\<ä½ >\...\age.key`
- ç¡®è®¤ `.sops.yaml` ä¸­çš„ public key ä¸ä½ çš„ age key pair åŒ¹é…

### Q: çŸ¥è¯†åº“æ•°æ®åœ¨å“ªï¼Ÿæ€ä¹ˆæ¸…ç©ºï¼Ÿ
- ä½ç½®ï¼š`./data/chromadb/`
- æ¸…ç©ºï¼šåˆ é™¤æ•´ä¸ª `data/` æ–‡ä»¶å¤¹ï¼Œé‡å¯æœåŠ¡å™¨ä¼šè‡ªåŠ¨é‡å»ºç©ºåº“

### Q: relevance å€¼æ€ä¹ˆçœ‹ï¼Ÿ
| èŒƒå›´ | å«ä¹‰ |
|------|------|
| 0.8 - 1.0 | é«˜åº¦ç›¸å…³ |
| 0.5 - 0.8 | ä¸­ç­‰ç›¸å…³ |
| 0.3 - 0.5 | å¼±ç›¸å…³ |
| < 0.3 | åŸºæœ¬ä¸ç›¸å…³ï¼ˆRAG é—®ç­”ä¼šè¿‡æ»¤æ‰ï¼‰ |

### Q: æ—¥å¿—åœ¨å“ªçœ‹ï¼Ÿ
- æ§åˆ¶å°å®æ—¶è¾“å‡ºï¼ˆDEBUG çº§åˆ«ï¼‰
- æ–‡ä»¶æ—¥å¿—ï¼š`logs/` ç›®å½•ä¸‹ï¼ŒæŒ‰æ—¶é—´å‘½åï¼Œè‡ªåŠ¨è½®æ¢

---

## é¡¹ç›®æ–‡ä»¶ç´¢å¼•

```
.
â”œâ”€â”€ server.py                      # å…¥å£ï¼Œå¯åŠ¨ MCP Server
â”œâ”€â”€ config.yaml                    # å…¨å±€é…ç½®
â”œâ”€â”€ env.yaml                       # SOPS åŠ å¯†çš„ API Key
â”œâ”€â”€ .sops.yaml                     # SOPS åŠ å¯†è§„åˆ™
â”œâ”€â”€ pyproject.toml                 # ä¾èµ–ç®¡ç†
â”œâ”€â”€ .python-version                # Python 3.13
â”œâ”€â”€ .gitignore                     # Git å¿½ç•¥è§„åˆ™ï¼ˆå« data/ï¼‰
â”‚
â”œâ”€â”€ core/                          # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ llm_service.py             # DeepSeek API è°ƒç”¨
â”‚   â”œâ”€â”€ knowledge_store.py         # ChromaDB å‘é‡æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ rag_service.py             # RAG æ£€ç´¢å¢å¼ºç”Ÿæˆ
â”‚   â”œâ”€â”€ document_processor.py      # æ–‡æœ¬åˆ†å—
â”‚   â”œâ”€â”€ translate_service.py       # ç¿»è¯‘ API
â”‚   â””â”€â”€ weather_service.py         # å¤©æ°” API
â”‚
â”œâ”€â”€ tools/                         # MCP å·¥å…·ï¼ˆè‡ªåŠ¨æ³¨å†Œï¼‰
â”‚   â”œâ”€â”€ chat_tool.py               # smart_chat
â”‚   â”œâ”€â”€ knowledge_tool.py          # add/search/list/delete_knowledge
â”‚   â”œâ”€â”€ qa_tool.py                 # ask_knowledge, knowledge_stats
â”‚   â”œâ”€â”€ translate_tool.py          # text_translate, get_supported_languages
â”‚   â””â”€â”€ weather_tool.py            # weather_query
â”‚
â”œâ”€â”€ prompts/                       # MCP æç¤ºè¯ï¼ˆè‡ªåŠ¨æ³¨å†Œï¼‰
â”‚   â””â”€â”€ knowledge_prompt.py        # knowledge_qa, knowledge_import
â”‚
â”œâ”€â”€ resources/                     # MCP èµ„æºï¼ˆè‡ªåŠ¨æ³¨å†Œï¼‰
â”‚   â””â”€â”€ knowledge_resource.py      # knowledge_guide
â”‚
â”œâ”€â”€ modules/                       # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ YA_Common/                 # é…ç½®ã€æ—¥å¿—ã€å·¥å…·
â”‚   â””â”€â”€ YA_Secrets/                # SOPS è§£å¯†
â”‚
â””â”€â”€ data/chromadb/                 # å‘é‡æ•°æ®åº“å­˜å‚¨ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼ŒGitå¿½ç•¥ï¼‰
```
